<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detección de desenfoque</title>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    video, canvas {
      display: block;
      margin: 10px auto;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline width="640" height="480"></video>
  <canvas id="canvas" width="640" height="480"></canvas>
  <p id="status">Estado: Detectando...</p>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusText = document.getElementById('status');
    const ctx = canvas.getContext('2d');

    // Iniciar la cámara
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => console.error('Error al acceder a la cámara:', err));

    // Procesar el vídeo cuando OpenCV esté listo
    video.addEventListener('play', () => {
      const cap = new cv.VideoCapture(video);

      function processVideo() {
        if (!video.paused && !video.ended) {
          const src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
          const gray = new cv.Mat();
          const dst = new cv.Mat();

          cap.read(src); // Captura el fotograma
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY); // Convierte a escala de grises

          // Aplica el Laplaciano para detectar desenfoque
          cv.Laplacian(gray, dst, cv.CV_64F);
          const meanStdDev = new cv.Mat();
          cv.meanStdDev(dst, meanStdDev);

          const variance = meanStdDev.data64F[1]; // Varianza del laplaciano

          // Determinar si está desenfocado
          if (variance < 100) { // Ajusta el umbral según tus necesidades
            statusText.textContent = 'Estado: Desenfocado';
          } else {
            statusText.textContent = 'Estado: Enfocado';
          }

          // Muestra el vídeo en el canvas
          cv.imshow(canvas, src);

          // Liberar memoria
          src.delete();
          gray.delete();
          dst.delete();
          meanStdDev.delete();

          requestAnimationFrame(processVideo);
        }
      }

      processVideo();
    });
  </script>
</body>
</html>
